{% extends 'base.html' %}

{% load i18n %}
{% load static %}

{% block title %}{% trans 'Rate Comments by Other Users' %}{% endblock %}
{% block main-heading %}{% trans 'Rate Comments by Other Users' %}{% endblock %}

{% block static-assets %}
  {{ block.super }}
  <script src="{% static 'js/d3.v4.min.js' %}"></script>
{% endblock %}

{% block scripts %}
  <script>
    // `fa-comment` from Font Awesome
    const ICON_IMAGE = 'iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAABDklEQVR4nNXVzyqEURzG8c+8+Z/i'
                     + 'DmwkKymRspNbsLBxA27AzkLZyF7Kn4XsJEulRsMVuAHJhiZRUzKpGYuZt6bXyzDOSZ56luf7PefX'
                     + 'qR9/mDGs4QxPqGf6jEusY+In4DmUcoDteoX5r8Dd2OkAnO0e+rLwXpwHgKctob9VsB0QnvYohc9G'
                     + 'gKdd0DTFEhzDTUTBfQFV9IiTtwTlSHB4SFCMKCjCNGrCz7+GqdS0EUGw2fqUAvYDwg+R5M1sBS+/'
                     + 'AL9itXnhT7PbAbiKA4xmYVnTIO4wnCMuY6h5poJbXOMCpxo7o222cm5XweJ3DrfLko/f9QQjIeDj'
                     + 'GnOs41FjaUyGAKcZwDJm0BUS/P/zDqZIDzgtIDS2AAAAAElFTkSuQmCC';

    function startDrag(d) {
      if (!d3.event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function continueDrag(d) {
      d.fx = d3.event.x;
      d.fy = d3.event.y;
    }

    function endDrag(d) {
      if (!d3.event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }

    var simulation;

    function renderComments() {
      var bloom = d3.select('#bloom'),
          width = bloom.node().getBoundingClientRect().width,
          height = width * 0.6;
      bloom.attr('height', height);

      console.log('Rendering ' + width + 'x' + height + ' bloom');
      simulation = d3.forceSimulation().force('charge', d3.forceManyBody());
      bloom.selectAll('*').remove();

      var selectedComments = JSON.parse(localStorage.getItem(SELECTED_COMMENTS_KEY)) || {};
      var nodeData = [];
      for (var commentID in selectedComments) {
        nodeData.push({
          x: Math.random() * width,
          y: Math.random() * height,
        });
      }

      var drag = d3.drag()
                   .on('start', startDrag)
                   .on('drag', continueDrag)
                   .on('end', endDrag);

      var nodes = bloom.selectAll('g').data(nodeData).enter().append('g');
      nodes.call(drag).on('click', function() { console.log('OK'); });
      nodes.append('image').attr('xlink:href', 'data:image/png;base64,' + ICON_IMAGE);
      nodes.append('text').text('(?)').attr('x', 30).attr('y', 15).attr('fill', '#1371ad');

      function tick() {
        nodes.attr('transform', function(node) {
          var x = Math.max(0, Math.min(node.x, width - 100));
          var y = Math.max(20, Math.min(node.y, height - 20));
          return 'translate(' + x + ', ' + y + ')';
        });
      }

      simulation.nodes(nodeData).on('tick', tick);
    }

    $(document).ready(function() {
      selectComments(selectCommentFromStandardError);
      renderComments();
    });

    $(window).resize(renderComments);
  </script>
{% endblock %}

{% block content %}
  <p>
    {% blocktrans trimmed %}
      Each icon below is a comment made by another user.
      Next to each icon is the topic of the comment, or <span style='color: #1371ad'>(?)</span> if no topic was found.
      Comments that are closer together have authors who answered the quantitative questions similarly.
    {% endblocktrans %}
  <p>
    {% blocktrans trimmed %}
      Click an icon to rate that comment on its helpfulness.
      You can also drag the icons around.
    {% endblocktrans %}
  </p>

  <svg id='bloom' width="100%"></svg>

  <div class="nav-button">
    <a href="{% url 'pcari:qualitative-questions' %}?lang={{ language_code }}">Next</a>
  </div>
{% endblock %}
