{% extends 'base.html' %}

{% load i18n %}
{% load static %}

{% block title %}{% trans 'Survey Questions' %}{% endblock %}
{% block main-heading %}
  {% blocktrans trimmed %}
    Welcome! Please answer {{ num_questions }} quick questions to get started.
  {% endblocktrans %}
{% endblock %}

{% block scripts %}
  <script>
    const SKIPPED = null;

    function getSortedQuestionIDs() {
      var questionIDs = Object.keys(Resource.get('quantitative-questions').data);
      for (var index in questionIDs) {
        questionIDs[index] = parseInt(questionIDs[index]);
      }
      questionIDs.sort();
      return questionIDs;
    }

    function currentQuestionIndex(questionIDs) {
      var questionRatings = getResponseValue(['question-ratings']);
      for (var index in questionIDs) {
        if (!(questionIDs[index] in questionRatings)) {
          return parseInt(index);
        }
      }
      return questionIDs.length - 1;
    }

    var LANGUAGE = $('html').attr('lang') || DEFAULT_LANGUAGE;

    function renderQuestion(questionIDs, index) {
      if (index >= questionIDs.length) {
        redirect(APP_URL_ROOT + '/' + LANGUAGE + '/rate-comments/');
      }

      if (index === 0) {
        $('#previous').prop('disabled', true);
      } else {
        $('#previous').prop('disabled', false);
      }
      $('#answer').empty();
      $('#skip-notice').css('display', 'none');

      var questionID = questionIDs[index];
      var questionData = Resource.load('quantitative-questions').data[questionID];

      var min = questionData['min-score'] || 0;
      var max = questionData['max-score'] || 9;

      var value = getResponseValue(['question-ratings', questionID]);
      if (value === SKIPPED) {
        $('#skip-notice').css('display', 'block');
        value = min;
      } else {
        value = value === undefined ? min : value;
      }

      var prompt = questionData['prompts'][LANGUAGE];
      var left_anchor = questionData['left-anchors'][LANGUAGE];
      var right_anchor = questionData['right-anchors'][LANGUAGE];

      $('#prompt').text(prompt);
      if (questionData['input-type'] === 'range') {
        var input = $('<div class="range-container"></div>');
        var range = $('<input id="quantitative-input" type="range" value="'
                      + value + '" min="' + min + '" max="' + max + '" step="1">');
        input.append(range);
        input.append($('<span class="left-anchor">' + left_anchor + '</span>'));
        input.append($('<span class="right-anchor">' + right_anchor + '</span>'));
        $('#answer').append(input);

        range.on('input', updateOutputReading);
      } else if (questionData['input-type'] === 'number') {
        var input = $('<input id="quantitative-input" type="number" min="'
                      + min + '" max="' + max + '" step="1">');
        $('#answer').append(input);
        if (value !== SKIPPED) {
          $('#answer').val(value);
        }
      }

      $('#progression-numerator').text(questionIndex + 1);
    }

    const QUESTION_IDS = getSortedQuestionIDs();
    if (QUESTION_IDS.length === 0) {
      redirect(APP_URL_ROOT + '/' + LANGUAGE + '/rate-comments/');
    }
    var questionIndex = currentQuestionIndex(QUESTION_IDS);

    $(document).ready(function() {
      displayNoCurrentRespondentError();

      if (!Resource.exists('quantitative-questions')) {
        displayError('No quantitative question data found.');
        return;
      }

      renderQuestion(QUESTION_IDS, questionIndex);
      $('#progression-denominator').text(QUESTION_IDS.length);

      $('#previous').on('click', function() {
        questionIndex--;
        renderQuestion(QUESTION_IDS, questionIndex);
      });

      $('#skip').on('click', function() {
        var questionID = QUESTION_IDS[questionIndex];
        setResponseValue(['question-ratings', questionID], SKIPPED);
        questionIndex++;
        renderQuestion(QUESTION_IDS, questionIndex);
      });

      $('#submit').on('click', function() {
        var score = parseInt($('#quantitative-input').val());
        var questionID = QUESTION_IDS[questionIndex];
        var path = ['question-ratings', questionID];
        if (isNaN(score)) {
          deleteResponsevalue(path);
        } else {
          setResponseValue(path, score);
        }
        questionIndex++;
        renderQuestion(QUESTION_IDS, questionIndex);
      });
    });
  </script>
{% endblock %}

{% block content %}
  <p id="progression">
    <strong>
      {% trans 'Question' %} <span id="progression-numerator"></span>/<span id="progression-denominator"></span>:
    </strong>
  </p>
  <p id="prompt"></p>
  <div id="answer"></div>
  <!-- FIXME: more elegant solution for translations -->
  <div class="center">
    <p id="skip-notice">
      {% trans 'You previously chose to skip this question.' %}
    </p>
  </div>
  <ul class="button-group">
    <li>
      <button id="previous">{% trans 'Back' %}</button>
    </li>
    <li>
      <button id="submit">{% trans 'Submit' %}</button>
    </li>
    <li>
      <button id="skip">{% trans 'Skip' %}</button>
    </li>
  </ul>
{% endblock %}
