{% extends 'base.html' %}

{% load i18n %}
{% load static %}

{% block title %}{% trans 'Survey Questions' %}{% endblock %}
{% block main-heading %}{% trans 'Survey Questions' %}{% endblock %}

{% block scripts %}
  <script>
    const QUANTITATIVE_QUESTIONS = (Resource.load('quantitative-questions') || {data: []}).data;
    const OPTION_QUESTIONS = (Resource.load('option-questions') || {data: []}).data;
    const NUM_QUESTIONS = QUANTITATIVE_QUESTIONS.length + OPTION_QUESTIONS.length;

    function currentQuestionIndex() {
      var ratings = getResponseValue(['question-ratings']) || [];
      for (var index in QUANTITATIVE_QUESTIONS) {
        var question = QUANTITATIVE_QUESTIONS[index];
        if (!(question.id in ratings)) {
          return parseInt(index);
        }
      }

      var choices = getResponseValue(['question-choices']) || [];
      for (var index in OPTION_QUESTIONS) {
        var question = OPTION_QUESTIONS[index];
        if (!(question.id in choices)) {
          return QUANTITATIVE_QUESTIONS.length + parseInt(index);
        }
      }

      return Math.max(0, NUM_QUESTIONS - 1);
    }

    function randint(a, b) {
      return Math.floor((b - a + 1)*Math.random()) + a;
    }

    function renderQuantitativeQuestion(question) {
      var language = getCurrentLanguage();
      var container = $('<div>').addClass('range-container');
      var min = question['min-score'] || 0, max = question['max-score'] || 9, step = question['step'] || 1;
      var value = getResponseValue(['question-ratings', question.id]);
      $('#prompt').text(question.prompts[language] || '');

      if (question['input-type'] === 'range') {
        var range = $('<input>').attr('id', 'quantitative-input').attr('type', 'range');
        range = range.attr('min', min).attr('max', max).attr('value', value || randint(min, max)).attr('step', step);
        container.append(range);
        container.append($('<span>').addClass('left-anchor').text(question['left-anchors'][language] || ''));
        container.append($('<span>').addClass('right-anchor').text(question['right-anchors'][language] || ''));
        $('#answer').append(container);

        var reading = $('<output>').attr('id', 'quantitative-output');
        var output = $('<p>').append(gettext('Your current answer is: ')).append(reading);
        $('#notice').append(output);

        function updateOutputReading() {
          $('#quantitative-output').text(range.val() + '/' + max);
        };

        range.on('input', updateOutputReading);
        updateOutputReading();
        $('#current-answer-notice').css('display', 'block');
      } else if (question['input-type'] === 'number') {
        var number = $('<input>').attr('id', 'quantitative-input').attr('type', 'number');
        number = number.attr('min', min).attr('max', max).attr('step', step);
        if (value !== SKIPPED) {
          number.attr('value', value);
        }
        $('#answer').append(number);
      }

      if (value === SKIPPED) {
        $('#notice').append($('<p>').text(gettext('You previously chose to skip this question.')));
      }
    }

    function renderOptionQuestion(question) {
      var language = getCurrentLanguage();
      $('#prompt').text(question.prompts[language] || '');
      var choices = question.options[language];
      var previousAnswer = getResponseValue(['question-choices', question.id]);

      if (question['input-type'] === 'select') {
        var select = $('<select>').attr('id', 'option-input');
        for (var index in choices) {
          var choice = choices[index];
          select.append($('<option>').text(choice).prop('selected', previousAnswer === choice));
        }
        $('#answer').append(select);
      } else if (question['input-type'] === 'radio') {
        // TODO
      }

      if (previousAnswer === null) {
        $('#notice').append($('<p>').text(gettext('You previously chose to skip this question.')));
      }
    }

    function renderQuestion(questionIndex) {
      if (questionIndex >= NUM_QUESTIONS) {
        redirect(APP_URL_ROOT + '/' + getCurrentLanguage() + '/rate-comments/');
      }

      $('#previous').prop('disabled', questionIndex === 0);
      $('#answer').empty();
      $('#notice').empty();
      $('#progression-numerator').text(questionIndex + 1);
      $('#current-answer-notice').css('display', 'none');
      $('#skip-notice').css('display', 'none');

      if (questionIndex < QUANTITATIVE_QUESTIONS.length) {
        renderQuantitativeQuestion(QUANTITATIVE_QUESTIONS[questionIndex]);
      } else {
        renderOptionQuestion(OPTION_QUESTIONS[questionIndex - QUANTITATIVE_QUESTIONS.length]);
      }
    }

    $(document).ready(function() {
      displayNoCurrentRespondentError();
      $('#progression-denominator').text(NUM_QUESTIONS);

      var questionIndex = currentQuestionIndex();
      renderQuestion(questionIndex);
      $('#previous').on('click', function() {
        questionIndex--;
        renderQuestion(questionIndex);
      });
      $('#skip').on('click', function() {
        if (questionIndex < QUANTITATIVE_QUESTIONS.length) {
          var question = QUANTITATIVE_QUESTIONS[questionIndex];
          setResponseValue(['question-ratings', question.id], SKIPPED);
        } else {
          var question = OPTION_QUESTIONS[questionIndex - QUANTITATIVE_QUESTIONS.length];
          setResponseValue(['question-choices', question.id], SKIPPED);
        }
        questionIndex++;
        renderQuestion(questionIndex);
      });
      $('#submit').on('click', function() {
        if (questionIndex < QUANTITATIVE_QUESTIONS.length) {
          var question = QUANTITATIVE_QUESTIONS[questionIndex];
          var path = ['question-ratings', question.id];
          var score = parseInt($('#quantitative-input').val());
          if (isNaN(score)) {
            deleteResponseValue(path);
          } else {
            setResponseValue(path, score);
          }
        } else {
          var question = OPTION_QUESTIONS[questionIndex - QUANTITATIVE_QUESTIONS.length];
          setResponseValue(['question-choices', question.id], $('#option-input').val());
        }
        questionIndex++;
        renderQuestion(questionIndex);
      });
    });
  </script>
{% endblock %}

{% block content %}
  <p class="instructions">
    <strong>
      {% blocktrans trimmed %}
        Below, you will see either a slider or a text box.
        Please answer each question by moving the slider knob or filling in the box with a number.
      {% endblocktrans %}
    </strong>
  </p>
  <p id="progression">
    <strong>
      {% trans 'Question' %} <span id="progression-numerator"></span>/<span id="progression-denominator"></span>:
    </strong>
  </p>
  <p id="prompt"></p>
  <div id="answer"></div>
  <div id="notice" class="center"></div>
  <ul class="button-group">
    <li>
      <button id="previous" class="blue">{% trans 'Previous' %}</button>
    </li>
    <li>
      <button id="skip" class="red">{% trans 'Skip' %}</button>
    </li>
    <li>
      <button id="submit" class="blue">{% trans 'Submit' %}</button>
    </li>
  </ul>
{% endblock %}
